#!/sbin/sh
# AnyKernel3 Backend (DO NOT CHANGE)
# osm0sis @ xda-developers

export OUTFD=$2;
export ZIPFILE="$3";

BOOTMODE=false;
ps | grep zygote | grep -v grep >/dev/null && BOOTMODE=true;
$BOOTMODE || ps -A 2>/dev/null | grep zygote | grep -v grep >/dev/null && BOOTMODE=true;

DIR=/sdcard;
$BOOTMODE || DIR=$(dirname "$ZIPFILE");
[ $DIR == "/sideload" ] && DIR=/tmp;

[ -d /postinstall/tmp ] && POSTINSTALL=/postinstall;
[ "$AKHOME" ] || export AKHOME=$POSTINSTALL/tmp/anykernel;
[ "$ANDROID_ROOT" ] || ANDROID_ROOT=/system;

ui_print() {
  until [ ! "$1" ]; do
    echo "ui_print $1
      ui_print" >> /proc/self/fd/$OUTFD;
    shift;
  done;
}
ui_printfile() {
  local line losrpad;
  $BOOTMODE || [ -e /twres ] || losrpad='| '; # work around LOS Recovery eating leading whitespace
  while IFS='' read -r line || [[ -n "$line" ]]; do
    ui_print "$losrpad$line";
  done < $1;
}
show_progress() { echo "progress $1 $2" >> /proc/self/fd/$OUTFD; }
file_getprop() { grep "^$2=" "$1" | tail -n1 | cut -d= -f2-; }
find_slot() {
  local slot=$(getprop ro.boot.slot_suffix 2>/dev/null);
  [ "$slot" ] || slot=$(grep -o 'androidboot.slot_suffix=.*$' /proc/cmdline | cut -d\  -f1 | cut -d= -f2);
  if [ ! "$slot" ]; then
    slot=$(getprop ro.boot.slot 2>/dev/null);
    [ "$slot" ] || slot=$(grep -o 'androidboot.slot=.*$' /proc/cmdline | cut -d\  -f1 | cut -d= -f2);
    [ "$slot" ] && slot=_$slot;
  fi;
  [ "$slot" == "normal" ] && unset slot;
  [ "$slot" ] && echo "$slot";
}
setup_mountpoint() {
  [ -L $1 ] && mv -f $1 ${1}_link;
  if [ ! -d $1 ]; then
    rm -f $1;
    mkdir -p $1;
  fi;
}
is_mounted() { mount | grep -q " $1 "; }
mount_apex() {
  [ -d /system_root/system/apex ] || return 1;
  local apex dest loop minorx num shcon var;
  setup_mountpoint /apex;
  mount -t tmpfs tmpfs /apex -o mode=755 && touch /apex/apextmp;
  shcon=$(cat /proc/self/attr/current);
  echo "u:r:su:s0" > /proc/self/attr/current 2>/dev/null; # work around LOS Recovery not allowing loop mounts in recovery context
  minorx=1;
  [ -e /dev/block/loop1 ] && minorx=$(ls -l /dev/block/loop1 | awk '{ print $6 }');
  num=0;
  for apex in /system_root/system/apex/*; do
    dest=/apex/$(basename $apex | sed -E -e 's;\.apex$|\.capex$;;' -e 's;\.current$|\.release$;;');
    mkdir -p $dest;
    case $apex in
      *.apex|*.capex)
        unzip -qo $apex original_apex -d /apex;
        [ -f /apex/original_apex ] && apex=/apex/original_apex;
        unzip -qo $apex apex_payload.img -d /apex;
        mv -f /apex/original_apex $dest.apex 2>/dev/null;
        mv -f /apex/apex_payload.img $dest.img;
        mount -t ext4 -o ro,noatime $dest.img $dest 2>/dev/null && echo "$dest (direct)" >&2;
        if [ $? != 0 ]; then
          while [ $num -lt 64 ]; do
            loop=/dev/block/loop$num;
            [ -e $loop ] || mknod $loop b 7 $((num * minorx));
            losetup $loop $dest.img 2>/dev/null;
            num=$((num + 1));
            losetup $loop | grep -q $dest.img && break;
          done;
          mount -t ext4 -o ro,loop,noatime $loop $dest && echo "$dest (loop)" >&2;
          if [ $? != 0 ]; then
            losetup -d $loop 2>/dev/null;
            if [ $num -eq 64 -a $(losetup -f) == "/dev/block/loop0" ]; then
              echo "Aborting apex mounts due to broken environment..." >&2;
              break;
            fi;
          fi;
        fi;
      ;;
      *) mount -o bind $apex $dest && echo "$dest (bind)" >&2;;
    esac;
  done;
  echo "$shcon" > /proc/self/attr/current 2>/dev/null;
  for var in $(grep -o 'export .* /.*' /system_root/init.environ.rc | awk '{ print $2 }'); do
    eval OLD_${var}=\$$var;
  done;
  $(grep -o 'export .* /.*' /system_root/init.environ.rc | sed 's; /;=/;'); unset export;
  touch /apex/apexak3;
}
umount_apex() {
  [ -f /apex/apexak3 ] || return 1;
  echo "Unmounting apex..." >&2;
  local dest loop var;
  for var in $(grep -o 'export .* /.*' /system_root/init.environ.rc 2>/dev/null | awk '{ print $2 }'); do
    if [ "$(eval echo \$OLD_$var)" ]; then
      eval $var=\$OLD_${var};
    else
      eval unset $var;
    fi;
    unset OLD_${var};
  done;
  for dest in $(find /apex -type d -mindepth 1 -maxdepth 1); do
    loop=$(mount | grep $dest | grep loop | cut -d\  -f1);
    umount -l $dest;
    losetup $loop >/dev/null 2>&1 && losetup -d $loop;
  done;
  [ -f /apex/apextmp ] && umount /apex;
  rm -rf /apex/apexak3 /apex 2>/dev/null;
}
mount_all() {
  local byname mount slot system;
  echo "Mounting..." >&2;
  byname=bootdevice/by-name;
  [ -d /dev/block/$byname ] || byname=$(find /dev/block/platform -type d -name by-name 2>/dev/null | head -n1 | cut -d/ -f4-);
  [ -e /dev/block/$byname/super -a -d /dev/block/mapper ] && byname=mapper;
  [ -e /dev/block/$byname/system ] || slot=$(find_slot);
  for mount in /cache /data /metadata /persist; do
    if ! is_mounted $mount; then
      mount $mount 2>/dev/null && echo "$mount (fstab)" >&2 && UMOUNTLIST="$UMOUNTLIST $mount";
      if [ $? != 0 -a -e /dev/block/$byname$mount ]; then
        setup_mountpoint $mount;
        mount -o ro -t auto /dev/block/$byname$mount $mount && echo "$mount (direct)" >&2 && UMOUNTLIST="$UMOUNTLIST $mount";
      fi;
    fi;
  done;
  setup_mountpoint $ANDROID_ROOT;
  if ! is_mounted $ANDROID_ROOT; then
    mount -o ro -t auto $ANDROID_ROOT 2>/dev/null && echo "$ANDROID_ROOT (\$ANDROID_ROOT)" >&2;
  fi;
  case $ANDROID_ROOT in
    /system_root) setup_mountpoint /system;;
    /system)
      if ! is_mounted /system && ! is_mounted /system_root; then
        setup_mountpoint /system_root;
        mount -o ro -t auto /system_root && echo "/system_root (fstab)" >&2;
      elif [ -f /system/system/build.prop ]; then
        setup_mountpoint /system_root;
        mount --move /system /system_root && echo "/system_root (moved)" >&2;
      fi;
      if [ $? != 0 ]; then
        (umount /system;
        umount -l /system) 2>/dev/null;
        mount -o ro -t auto /dev/block/$byname/system$slot /system_root && echo "/system_root (direct)" >&2;
      fi;
    ;;
  esac;
  [ -f /system_root/system/build.prop ] && system=/system;
  for mount in /vendor /product /system_ext; do
    mount -o ro -t auto $mount 2>/dev/null && echo "$mount (fstab)" >&2;
    if [ $? != 0 ] && [ -L /system$mount -o -L /system_root$system$mount ]; then
      setup_mountpoint $mount;
      mount -o ro -t auto /dev/block/$byname$mount$slot $mount && echo "$mount (direct)" >&2;
    fi;
  done;
  if is_mounted /system_root; then
    mount_apex;
    mount -o bind /system_root$system /system && echo "/system (bind)" >&2;
  fi;
  echo " " >&2;
}
umount_all() {
  local mount;
  echo "Unmounting..." >&2;
  (if [ ! -d /postinstall/tmp ]; then
    umount /system;
    umount -l /system;
  fi) 2>/dev/null;
  umount_apex;
  (if [ ! -d /postinstall/tmp ]; then
    umount /system_root;
    umount -l /system_root;
  fi;
  PATH="$OLD_PATH" umount /vendor; # busybox umount /vendor breaks recovery on some hacky devices
  PATH="$OLD_PATH" umount -l /vendor;
  for mount in /mnt/system /mnt/vendor /product /mnt/product /system_ext /mnt/system_ext $UMOUNTLIST; do
    umount $mount;
    umount -l $mount;
  done) 2>/dev/null;
}
setup_env() {
  $BOOTMODE && return 1;
  mount -o bind /dev/urandom /dev/random;
  if [ -L /etc ]; then
    setup_mountpoint /etc;
    cp -af /etc_link/* /etc;
    sed -i 's; / ; /system_root ;' /etc/fstab;
  fi;
  umount_all;
  mount_all;
  OLD_LD_PATH=$LD_LIBRARY_PATH;
  OLD_LD_PRE=$LD_PRELOAD;
  OLD_LD_CFG=$LD_CONFIG_FILE;
  unset LD_LIBRARY_PATH LD_PRELOAD LD_CONFIG_FILE;
  if [ ! "$(getprop 2>/dev/null)" ]; then
    getprop() {
      local propdir propfile propval;
      for propdir in / /system_root /system /vendor /product /product/etc /system_ext/etc /odm/etc; do
        for propfile in default.prop build.prop; do
          if [ "$propval" ]; then
            break 2;
          else
            propval="$(file_getprop $propdir/$propfile $1 2>/dev/null)";
          fi;
        done;
      done;
      echo "$propval";
    }
  elif [ ! "$(getprop ro.build.type 2>/dev/null)" ]; then
    getprop() {
      ($(which getprop) | grep "$1" | cut -d[ -f3 | cut -d] -f1) 2>/dev/null;
    }
  fi;
}
restore_env() {
  $BOOTMODE && return 1;
  local dir;
  unset -f getprop;
  [ "$OLD_LD_PATH" ] && export LD_LIBRARY_PATH=$OLD_LD_PATH;
  [ "$OLD_LD_PRE" ] && export LD_PRELOAD=$OLD_LD_PRE;
  [ "$OLD_LD_CFG" ] && export LD_CONFIG_FILE=$OLD_LD_CFG;
  unset OLD_LD_PATH OLD_LD_PRE OLD_LD_CFG;
  sleep 1;
  umount_all;
  [ -L /etc_link ] && rm -rf /etc/*;
  (for dir in /etc /apex /system_root /system /vendor /product /system_ext /metadata /persist; do
    if [ -L "${dir}_link" ]; then
      rmdir $dir;
      mv -f ${dir}_link $dir;
    fi;
  done;
  umount -l /dev/random) 2>/dev/null;
}
setup_bb() {
  local arch32 bb;
  for arch32 in x86 arm; do
    if [ -d $AKHOME/tools/$arch32 ]; then
      bb=$AKHOME/tools/$arch32/busybox;
      chmod 755 $bb;
      $bb >/dev/null 2>&1;
      if [ $? == 0 ]; then
        $bb mv -f $AKHOME/tools/$arch32/* $AKHOME/tools;
        break;
      fi;
    fi;
  done;
  bb=$AKHOME/tools/busybox;
  chmod 755 $bb;
  $bb chmod -R 755 tools bin;
  $bb --install -s bin;
}
debugging() {
  local debug log path;
  case $(basename "$ZIPFILE" .zip) in
    *-debugging) debug=1;;
  esac;
  for path in /tmp /cache /metadata /persist; do
    [ -f $path/.ak3-debugging ] && debug=1;
  done;
  if [ "$debug" ]; then
    ui_print " " "Creating debugging archive in $DIR...";
    [ -f /tmp/recovery.log ] && log=/tmp/recovery.log;
    tar -czf "$DIR/anykernel3-$(date +%Y-%m-%d_%H%M%S)-debug.tgz" $AKHOME $log;
  fi;
}
cleanup() {
  cd $AKHOME/../;
  rm -rf $AKHOME;
}
abort() {
  ui_print "$@";
  debugging;
  restore_env;
  if [ ! -f anykernel.sh -o "$(file_getprop anykernel.sh do.cleanuponabort 2>/dev/null)" == 1 ]; then
    cleanup;
  fi;
  exit 1;
}
do_devicecheck() {
  [ "$(file_getprop anykernel.sh do.devicecheck)" == 1 ] || return 1;
  local device devicename match product testname vendordevice vendorproduct;
  if [ "$REG" = "IDN" ];then
  ui_print "- Memeriksa Perangkat ...";
  elif [ "$REG" = "EN" ];then
  ui_print "- Checking Device ...";
  fi;
  device=$(getprop ro.product.device 2>/dev/null);
  product=$(getprop ro.build.product 2>/dev/null);
  vendordevice=$(getprop ro.product.vendor.device 2>/dev/null);
  vendorproduct=$(getprop ro.vendor.product.device 2>/dev/null);
  for testname in $($BB grep '^device.name.*=' anykernel.sh | $BB cut -d= -f2-); do
    for devicename in $device $product $vendordevice $vendorproduct; do
      if [ "$devicename" == "$testname" ]; then
        ui_print "- OK ! ";
        match=1;
        break 2;
      fi;
    done;
  done;
  if [ ! "$match" ]; then
	if [ "$REG" = "IDN" ];then
	abort "! Perangkat tidak didukung , Perangkat ini adalah $devicename . Membatalkan... !";
	elif [ "$REG" = "EN" ];then
    abort "! Unsupported device , This Device is $devicename . Aborting... !";
	fi;
  fi;
}
int2ver() {
  if [ "$1" -eq "$1" ] 2>/dev/null; then
    echo "$1.0.0";
  elif [ ! "$(echo "$1" | cut -d. -f3)" ]; then
    echo "$1.0";
  else
    echo "$1";
  fi;
}
do_versioncheck() {
  [ "$(file_getprop anykernel.sh supported.versions)" ] || return 1;
  local android_ver hi_ver lo_ver parsed_ver supported supported_ver;
  supported_ver=$(file_getprop anykernel.sh supported.versions | $BB tr -d '[:space:]');
  android_ver=$(file_getprop /system/build.prop ro.build.version.release);
  parsed_ver=$(int2ver $android_ver);
  if echo $supported_ver | $BB grep -q '-'; then
    lo_ver=$(int2ver "$(echo $supported_ver | $BB cut -d- -f1)");
    hi_ver=$(int2ver "$(echo $supported_ver | $BB cut -d- -f2)");
    if echo -e "$hi_ver\n$lo_ver\n$parsed_ver" | $BB sort -g | $BB grep -n "$parsed_ver" | $BB grep -q '^2:'; then
      supported=1;
    fi;
  else
    for ver in $(echo $supported_ver | $BB sed 's;,; ;g'); do
      if [ "$(int2ver $ver)" == "$parsed_ver" ]; then
        supported=1;
        break;
      fi;
    done;
  fi;
  if [ "$REG" = "IDN" ];then
  ui_print "- Memeriksa Versi Android...";
  ui_print "- Versi Android: $android_ver ";
  elif [ "$REG" = "EN" ];then
  ui_print "- Checking Android Version...";
  ui_print "- Android Version: $android_ver ";
  fi;
  if [ "$supported" ]; then
	ui_print "- OK !";
  else
	if [ "$REG" = "IDN" ];then
	abort "! Versi Android tidak Kompatibel, Kernel ini hanya untuk Android $supported_ver saja . Membatalkan... !";
	elif [ "$REG" = "EN" ];then
    abort "! Unsupported Android version, This kernel only for Android $supported_ver . Aborting... !";
	fi;
  fi;
}
do_levelcheck() {
  [ "$(file_getprop anykernel.sh supported.patchlevels)" ] || return 1;
  local android_lvl hi_lvl lo_lvl parsed_lvl supported_lvl;
  ui_print "Checking Android security patch level...";
  supported_lvl=$(file_getprop anykernel.sh supported.patchlevels | grep -oE '[0-9]{4}-[0-9]{2}|-');
  android_lvl=$(file_getprop /system/build.prop ro.build.version.security_patch);
  parsed_lvl=$(echo $android_lvl | grep -oE '[0-9]{4}-[0-9]{2}');
  if echo $supported_lvl | grep -q '^\-'; then
    lo_lvl=0000-00;
    hi_lvl=$(echo $supported_lvl | awk '{ print $2 }');
  elif echo $supported_lvl | grep -q ' - '; then
    lo_lvl=$(echo $supported_lvl | awk '{ print $1 }');
    hi_lvl=$(echo $supported_lvl | awk '{ print $3 }');
  elif echo $supported_lvl | grep -q '\-$'; then
    lo_lvl=$(echo $supported_lvl | awk '{ print $1 }');
    hi_lvl=9999-99;
  fi;
  if echo -e "$hi_lvl\n$lo_lvl\n$parsed_lvl" | sort -g | grep -n "$parsed_lvl" | grep -q '^2:'; then
    ui_print "$android_lvl" " ";
  else
    abort " " "Unsupported Android security patch level. Aborting...";
  fi;
}
do_vendorlevelcheck() {
  [ "$(file_getprop anykernel.sh supported.vendorpatchlevels)" ] || return 1;
  local vendor_lvl hi_lvl lo_lvl parsed_lvl supported_lvl;
  ui_print "Checking Vendor security patch level...";
  supported_lvl=$(file_getprop anykernel.sh supported.vendorpatchlevels | grep -oE '[0-9]{4}-[0-9]{2}|-');
  vendor_lvl=$(file_getprop /vendor/build.prop ro.vendor.build.security_patch);
  parsed_lvl=$(echo $vendor_lvl | grep -oE '[0-9]{4}-[0-9]{2}');
  if echo $supported_lvl | grep -q '^\-'; then
    lo_lvl=0000-00;
    hi_lvl=$(echo $supported_lvl | awk '{ print $2 }');
  elif echo $supported_lvl | grep -q ' - '; then
    lo_lvl=$(echo $supported_lvl | awk '{ print $1 }');
    hi_lvl=$(echo $supported_lvl | awk '{ print $3 }');
  elif echo $supported_lvl | grep -q '\-$'; then
    lo_lvl=$(echo $supported_lvl | awk '{ print $1 }');
    hi_lvl=9999-99;
  fi;
  if echo -e "$hi_lvl\n$lo_lvl\n$parsed_lvl" | sort -g | grep -n "$parsed_lvl" | grep -q '^2:'; then
    ui_print "$vendor_lvl" " ";
  else
    abort " " "Unsupported Vendor security patch level. Aborting...";
  fi;
}
dump_moduleinfo() {
cat <<EOF > $1;
id=ak3-helper
name=AK3 Helper Module
version=$(awk '{ print $3 }' $AKHOME/vertmp) $(grep -oE '#.[0-9]' $AKHOME/vertmp)
versionCode=1
author=AnyKernel3
description=$KERNEL_STRING
EOF
}
dump_moduleremover() {
cat <<'EOF' > $1;
#!/system/bin/sh
MODDIR=${0%/*};
if [ "$(cat /proc/version)" != "$(cat $MODDIR/version)" ]; then
  rm -rf $MODDIR;
  exit;
fi;
rm -f $MODDIR/update;
. $MODDIR/post-fs-data.2.sh;
EOF
}
do_modules() {
  [ "$(file_getprop anykernel.sh do.modules)" == 1 ] || return 1;
  local block modcon moddir modtarget module mount slot umask umountksu;
  if [ "$(file_getprop anykernel.sh do.systemless)" == 1 ]; then
    if [ ! -d /data/adb -o ! -d /data/data/android ]; then
      ui_print " " "Warning: No /data access for kernel helper systemless module!";
      return 1;
    fi;
    cd $AKHOME/modules;
    ui_print " " "Creating kernel helper systemless module...";
    if [ -d /data/adb/magisk -a -f $AKHOME/magisk_patched ] || [ -d /data/data/me.weishu.kernelsu -a -f $AKHOME/kernelsu_patched ]; then
      umask=$(umask);
      moddir=/data/adb/modules/ak3-helper;
      # this may be the initial KernelSU install or first module so setup as needed
      if [ -f $AKHOME/kernelsu_patched ]; then
        umask 077;
        if [ ! -f /data/adb/ksud ]; then
          cp -f /data/app/*/me.weishu.kernelsu*/lib/*/libksud.so /data/adb/ksud;
          chmod 755 /data/adb/ksud;
        fi;
        if [ ! -d /data/adb/modules ]; then
          mkdir -p /data/adb/modules;
          chmod 777 /data/adb/modules;
        fi;
        [ -d /data/adb/modules_update ] || mkdir -p /data/adb/modules_update;
        [ -d /data/adb/ksu ] || mkdir -p /data/adb/ksu;
        [ -f /data/adb/ksu/modules.img ] && cp -f /data/adb/ksu/modules.img /data/adb/ksu/modules_update.img;
        if [ ! -f /data/adb/ksu/modules_update.img ]; then
          /system/bin/make_ext4fs -b 1024 -l 256M /data/adb/ksu/modules_update.img 2>/dev/null \
            || /system/bin/mke2fs -b 1024 -t ext4 /data/adb/ksu/modules_update.img 256M;
        fi;
        mount -t ext4 -o rw /data/adb/ksu/modules_update.img /data/adb/modules_update && umountksu=1;
        touch /data/adb/ksu/update;
        umask 022;
        rm -rf $moddir;
        mkdir -p $moddir;
        dump_moduleinfo $moddir/module.prop;
        touch $moddir/update;
        moddir=/data/adb/modules_update/ak3-helper;
      fi;
      umask 022;
      rm -rf $moddir;
      mkdir -p system $moddir;
      (mv -f product system;
      mv -f vendor system;
      mv -f system_ext system;
      mv -f post-fs-data.sh post-fs-data.2.sh) 2>/dev/null;
      cp -rLf * $moddir;
      dump_moduleinfo $moddir/module.prop;
      dump_moduleremover $moddir/post-fs-data.sh;
      cp -f $AKHOME/vertmp $moddir/version;
      touch $moddir/update;
      umask $umask;
      /system/bin/chcon -hR "u:object_r:system_file:s0" $moddir;
      [ "$umountksu" ] && umount /data/adb/modules_update;
    else
      ui_print "Magisk/KernelSU installation not found. Skipped!";
    fi;
  else
    cd $AKHOME/modules;
    ui_print " " "Pushing modules...";
    if [ -d /dev/block/mapper ]; then
      for block in system vendor product; do
        for slot in "" _a _b; do
          blockdev --setrw /dev/block/mapper/$block$slot 2>/dev/null;
        done;
      done;
    fi;
    if [ ! -d /postinstall/tmp ]; then
      for mount in /system /vendor /product; do
        if is_mounted $mount; then
          mount -o rw,remount -t auto $mount && echo "$mount (rw)" >&2;
        fi;
      done;
    fi;
    for module in $(find . -name '*.ko'); do
      modtarget=$POSTINSTALL$(echo $module | cut -c2-);
      if [ ! -e $modtarget ]; then
        case $module in
          */vendor/*) modcon=vendor;;
          */product/*) modcon=product;;
          *) modcon=system;;
        esac;
      fi;
      if is_mounted $modtarget; then
        mount -o rw,remount -t auto $modtarget && echo "$modtarget (rw)" >&2;
      fi;
      mkdir -p $(dirname $modtarget);
      cp -rLf $module $modtarget;
      chown 0:0 $modtarget;
      chmod 644 $modtarget;
      if [ "$modcon" ]; then
        /system/bin/chcon "u:object_r:${modcon}_file:s0" $modtarget;
      fi;
      if is_mounted $modtarget; then
        mount -o ro,remount -t auto $modtarget && echo "$modtarget (ro)" >&2;
      fi;
    done;
    if [ ! -d /postinstall/tmp ]; then
      for mount in /system /vendor /product; do
        if is_mounted $mount; then
          mount -o ro,remount -t auto $mount && echo "$mount (ro)" >&2;
        fi;
      done;
    fi;
  fi;
  cd $AKHOME;
}

DoneProcess(){
if [ "$REG" = "IDN" ];then
ui_print "- Selesai";
elif [ "$REG" = "EN" ];then
ui_print "- Done";
fi;
}

AddSpectrum(){
# custom script for spectrum
  $BB mount -o rw,remount -t auto /system;
  $BB mount -o rw,remount -t auto /vendor 2>/dev/null;
  
if [ "`$BB grep -w "selected.1=1" /tmp/aroma-data/spectrum.prop`" ] && [ -e $AKHOME/spectrum/init.spectrum.rc ];then
  cd $AKHOME;

  # add spectrum support
  if [ "$REG" = "IDN" ];then
  ui_print "- Mencadangkan Skrip Lama...";
  elif [ "$REG" = "EN" ];then
  ui_print "- Backing up Old Script in Progress...";
  fi;
    if [ ! -e /vendor/etc/init/hw/init.qcom.rc.backup ];then
      cp -af /vendor/etc/init/hw/init.qcom.rc /vendor/etc/init/hw/init.qcom.rc.backup
    fi
    if [ ! -e /vendor/etc/init/hw/init.spectrum.rc.backup ];then
      cp -af /vendor/etc/init/hw/init.spectrum.rc /vendor/etc/init/hw/init.spectrum.rc.backup
    fi
	if [ "$REG" = "IDN" ];then
	ui_print "- Menambal init.qcom.rc...";
	elif [ "$REG" = "EN" ];then
	ui_print "- Patching init.qcom.rc...";
	fi;
    grep "import /init.spectrum.rc" /vendor/etc/init/hw/init.qcom.rc >/dev/null | sed -i '/import \/init.spectrum.rc/d' /vendor/etc/init/hw/init.qcom.rc
    grep "import init.spectrum.rc" /vendor/etc/init/hw/init.qcom.rc >/dev/null | sed -i '/import init.spectrum.rc/d' /vendor/etc/init/hw/init.qcom.rc
    grep "import /vendor/etc/init/hw/init.spectrum.rc" /vendor/etc/init/hw/init.qcom.rc >/dev/null || sed -i '1,/.*import.*/s/.*import.*/import \/vendor\/etc\/init\/hw\/init.spectrum.rc\n&/' /vendor/etc/init/hw/init.qcom.rc
    if [ "$REG" = "IDN" ];then
	ui_print "- Menambal Skrip Spektrum...";
	elif [ "$REG" = "EN" ];then
	ui_print "- Patching Spectrum Script...";
	fi
	cp -af $AKHOME/spectrum/init.spectrum.rc /vendor/etc/init/hw/
    chmod -R 644 /vendor/etc/init/hw/init.spectrum.rc
	cp -af $AKHOME/spectrum/init.spectrum.sh /vendor/bin/
    chmod -R 755 /vendor/bin/init.spectrum.sh
    # cprofile remover
    if [ -e /system/xbin/cprofile ];then
      rm -rf /system/xbin/cprofile
      ui_print "remove /system/xbin/cprofile"
    fi
    if [ -e /system/bin/cprofile ];then
      rm -rf /system/bin/cprofile
      ui_print "remove /system/bin/cprofile"
    fi
    if [ -e /vendor/bin/cprofile ];then
      rm -rf /vendor/bin/cprofile
      ui_print "remove /vendor/bin/cprofile"
    fi
    if [ -e /system/init.spectrum.rc ];then
      rm -rf /system/init.spectrum.rc
      ui_print "remove /system/init.spectrum.rc"
    fi
    if [ -e /system/init.spectrum.sh ];then
      rm -rf /system/init.spectrum.sh
      ui_print "remove /system/init.spectrum.sh"
	fi
  elif [ "`$BB grep -w "selected.1=2" /tmp/aroma-data/spectrum.prop`" ] || [ ! -e $AKHOME/spectrum/init.spectrum.rc ];then
    if [ -e /vendor/etc/init/hw/init.spectrum.rc ];then
	  if [ "$REG" = "IDN" ];then
	  ui_print "- Menghapus Skrip Spectrum Lama..."
	  elif [ "$REG" = "EN" ];then
	  ui_print "- Removing old Spectrum Script..."
	  fi
      rm -rf /vendor/etc/init/hw/init.spectrum.rc
	  if [ -e /vendor/bin/init.spectrum.sh ];then
      rm -rf /vendor/bin/init.spectrum.sh
      fi
    fi
    if [ -e /vendor/etc/init/hw/init.qcom.rc.backup ];then
      cp -af /vendor/etc/init/hw/init.qcom.rc.backup /vendor/etc/init/hw/init.qcom.rc
      rm -rf /vendor/etc/init/hw/init.qcom.rc.backup
      grep "import /vendor/etc/init/hw/init.spectrum.rc" /vendor/etc/init/hw/init.qcom.rc >/dev/null | sed -i '/import \/vendor\/etc\/init\/hw\/init.spectrum.rc/d' /vendor/etc/init/hw/init.qcom.rc
    fi
  fi
  $BB mount -o ro,remount -t auto /system;
  $BB mount -o ro,remount -t auto /vendor 2>/dev/null;
}

RestorePerfHAL() {
	$BB mount -o rw,remount -t auto /system;
    $BB mount -o rw,remount -t auto /vendor 2>/dev/null;
	
	if [ -f /vendor/etc/perf/targetresourceconfigs.xml.bkp ] || [ -f /vendor/etc/perf/targetconfig.xml.bkp ] || [ -f /vendor/etc/perf/perfboostsconfig.xml.bkp ] || [ -f /vendor/etc/perf/commonresourceconfigs.xml.bkp ];then
	if [ "$REG" = "IDN" ];then
    ui_print "- Mengembalikan Perf HAL lama...";
    elif [ "$REG" = "EN" ];then
    ui_print "- Restoring old Perf HAL...";
    fi;
	mv -f /vendor/etc/perf/targetresourceconfigs.xml.bkp /vendor/etc/perf/targetresourceconfigs.xml
	mv -f /vendor/etc/perf/targetconfig.xml.bkp /vendor/etc/perf/targetconfig.xml
	mv -f /vendor/etc/perf/perfboostsconfig.xml.bkp /vendor/etc/perf/perfboostsconfig.xml
	mv -f /vendor/etc/perf/commonresourceconfigs.xml.bkp /vendor/etc/perf/commonresourceconfigs.xml
	rm -f /vendor/etc/perf/perfconfigstore.xml
	if [ "`$BB grep -w "selected.2=4" /tmp/aroma-data/spectrum.prop`" ]; then
	DoneProcess
	fi
	else
	if [ "$REG" = "IDN" ];then
    ui_print "! Perf HAL Lama tidak ditemukan. !";
    elif [ "$REG" = "EN" ];then
    ui_print "! Old Perf HAL not found. !";
    fi;
	if [ "`$BB grep -w "selected.2=4" /tmp/aroma-data/spectrum.prop`" ]; then
	if [ "$REG" = "IDN" ];then
    abort "- Membatalkan...";
    elif [ "$REG" = "EN" ];then
    abort "- Aborting...";
    fi;
	fi;
	fi;
  $BB mount -o ro,remount -t auto /system;
  $BB mount -o ro,remount -t auto /vendor 2>/dev/null;
}

refreshrate() {
if [ "`$BB grep -w "selected.3=1" /tmp/aroma-data/refrate.prop`" ];then
RR=48
elif [ "`$BB grep -w "selected.3=2" /tmp/aroma-data/refrate.prop`" ];then
RR=50
elif [ "`$BB grep -w "selected.3=3" /tmp/aroma-data/refrate.prop`" ];then
RR=55
elif [ "`$BB grep -w "selected.3=5" /tmp/aroma-data/refrate.prop`" ];then
RR=62
elif [ "`$BB grep -w "selected.3=6" /tmp/aroma-data/refrate.prop`" ];then
RR=64
elif [ "`$BB grep -w "selected.3=7" /tmp/aroma-data/refrate.prop`" ];then
RR=65
elif [ "`$BB grep -w "selected.3=8" /tmp/aroma-data/refrate.prop`" ];then
RR=67
elif [ "`$BB grep -w "selected.3=9" /tmp/aroma-data/refrate.prop`" ];then
RR=68
elif [ "`$BB grep -w "selected.3=10" /tmp/aroma-data/refrate.prop`" ];then
RR=69
elif [ "`$BB grep -w "selected.3=11" /tmp/aroma-data/refrate.prop`" ];then
RR=70
elif [ "`$BB grep -w "selected.3=12" /tmp/aroma-data/refrate.prop`" ];then
RR=72
else
RR=60
fi

dtc=$AKHOME/tools/dtc
dtp=$AKHOME/tools/dtp
screen=$RR
$BB dd if=/dev/block/bootdevice/by-name/boot of=$AKHOME/tools/boot.img

ui_print "- Refresh Rate: $screen Hz.";

if [ "$RR" = "60" ]; then
if [ "$REG" = "IDN" ];then
ui_print "- Melompati Modifikasi Refresh Rate ...";
elif [ "$REG" = "EN" ];then
ui_print "- Skipping Refresh Rate Modification ...";
fi;
else
if [ "$REG" = "IDN" ];then
ui_print "- Memodifikasi Refresh Rate ...";
elif [ "$REG" = "EN" ];then
ui_print "- Modifying Refresh Rate ...";
fi;
$AKHOME/tools/magiskboot unpack $AKHOME/tools/boot.img
$dtp -i kernel_dtb
if [ "$?" != "0" ]; then
abortrefrate=1
else
# decompile dtb
dtb_count=$(ls -lh kernel_dtb-* | wc -l)
board_id=$($BB cat /proc/device-tree/qcom,board-id | $BB xxd -p | $BB xargs echo | $BB sed 's/ //g' | $BB sed 's/.\{8\}/&\n/g' | $BB sed 's/^0\{6\}/0x/g' | $BB sed 's/^0\{5\}/0x/g' | $BB sed 's/^0\{4\}/0x/g' | $BB sed 's/^0\{3\}/0x/g' | $BB sed 's/^0\{2\}/0x/g' | $BB sed 's/^0\{1\}x*/0x/g' | $BB tr '\n' ' ' | $BB sed 's/ *$/\n/g')
msm_id=$($BB cat /proc/device-tree/qcom,msm-id | $BB xxd -p | $BB xargs echo | $BB sed 's/ //g' | $BB sed 's/.\{8\}/&\n/g' | $BB sed 's/^0\{6\}/0x/g' | $BB sed 's/^0\{5\}/0x/g' | $BB sed 's/^0\{4\}/0x/g' | $BB sed 's/^0\{3\}/0x/g' | $BB sed 's/^0\{2\}/0x/g' | $BB sed 's/^0\{1\}x*/0x/g' | $BB tr '\n' ' ' | $BB sed 's/ *$/\n/g')

i=0
while [ $i -lt $dtb_count ]; do
	$dtc -q -I dtb -O dts kernel_dtb-$i -o $AKHOME/tools/kernel_dtb_$i.dts
	dts_board_id=$($BB cat $AKHOME/tools/kernel_dtb_$i.dts | $BB grep qcom,board-id | $BB sed -e 's/[\t]*qcom,board-id = <//g' | $BB sed 's/>;//g')
	dts_msm_id=$($BB cat $AKHOME/tools/kernel_dtb_$i.dts | $BB grep qcom,msm-id | $BB sed -e 's/[\t]*qcom,msm-id = <//g' | $BB sed 's/>;//g')
	if [ "$dts_board_id" = "$board_id" ] && [ "$dts_msm_id" = "$msm_id" ]; then
		break
	fi
	$BB rm -f $AKHOME/tools/kernel_dtb_$i.dts
	i=$((i + 1))
done
fi
case $i in
$dtb_count)
abortrefrate=1
;;
esac

if [ "$abortrefrate" = "1" ]; then
if [ "$REG" = "IDN" ];then
ui_print "- Gagal Memodifikasi Refresh Rate ...";
elif [ "$REG" = "EN" ];then
ui_print "- Failed to Modify Refresh Rate ...";
fi;
else
# screen refresh rate
srr=qcom,mdss-dsi-panel-framerate
max_srr=qcom,mdss-dsi-max-refresh-rate
nsrr_=$(printf "0x%x" $screen)
$BB sed -i "s/$srr = <[^)]*>/$srr = <$nsrr_>/g" $AKHOME/tools/kernel_dtb_$i.dts
$BB sed -i "s/$max_srr = <[^)]*>/$max_srr = <$nsrr_>/g" $AKHOME/tools/kernel_dtb_$i.dts

# compile dts to dtb
$dtc -q -I dts -O dtb $AKHOME/tools/kernel_dtb_$i.dts -o kernel_dtb-$i

# generate new dtb
i=0
> kernel_dtb
while [ $i -lt $dtb_count ]; do
	$BB cat kernel_dtb-$i >> kernel_dtb
	i=$((i + 1))
done

$AKHOME/tools/magiskboot repack $AKHOME/tools/boot.img
$BB dd if=new-boot.img of=/dev/block/bootdevice/by-name/boot
$BB rm -f kernel_dtb-*
$BB rm -f new-boot.img
fi
fi
}

DoubleTapWake() {
$BB mount -o rw,remount -t auto /system;
$BB mount -o rw,remount -t auto /vendor 2>/dev/null;
	
if [ "`$BB grep -w "selected.2=1" /tmp/aroma-data/spectrum.prop`" ]; then
	if [ "$REG" = "IDN" ];then
	ui_print "- Menghidupkan Paksa DT2W ...";
	elif [ "$REG" = "EN" ];then
	ui_print "- Force Enabling DT2W ...";
	fi;
	DTTWScriptFile="/tmp/dttwpatch"
	DTTWInitFile="/tmp/dttwinit"
	$BB echo '#!/system/bin/sh' >> $DTTWScriptFile
	$BB echo '' >> $DTTWScriptFile
	$BB echo '# DT2W Enabler Script by RyuujiX' >> $DTTWScriptFile
	$BB echo '# Refined by sandatjepil' >> $DTTWScriptFile
	$BB echo '' >> $DTTWScriptFile
    $BB echo 'if [[ -f "/proc/touchpanel/double_tap_enable" ]]; then' >> $DTTWScriptFile
    $BB echo '  for dttw in $(find /proc/touchpanel -name "*enable"); do' >> $DTTWScriptFile
    $BB echo '    chmod -R 644 "$dttw"' >> $DTTWScriptFile
    $BB echo '    echo 1 > "$dttw"' >> $DTTWScriptFile
    $BB echo '  done' >> $DTTWScriptFile
    $BB echo 'elif [[ -f "/sys/kernel/touchpanel/dclicknode" ]]; then' >> $DTTWScriptFile
    $BB echo '  chmod -R 644 /sys/kernel/touchpanel/dclicknode' >> $DTTWScriptFile
    $BB echo '  echo 1 > "/sys/kernel/touchpanel/dclicknode"' >> $DTTWScriptFile
    $BB echo 'elif [[ -f "/proc/tpd_gesture" ]]; then' >> $DTTWScriptFile
    $BB echo '  chmod -R 644 /proc/tpd_gesture' >> $DTTWScriptFile
    $BB echo '  echo 1 > "/proc/tpd_gesture"' >> $DTTWScriptFile
    $BB echo 'fi' >> $DTTWScriptFile
	$BB echo '# DT2W Enabler Patch Init by RyuujiX' >> $DTTWInitFile
	$BB echo '# Refined by sandatjepil' >> $DTTWInitFile
	$BB echo '' >> $DTTWInitFile
	$BB echo 'on boot' >> $DTTWInitFile
	$BB echo 'chmod 0644 /proc/tpd_gesture' >> $DTTWInitFile
	$BB echo 'write /proc/tpd_gesture 1' >> $DTTWInitFile
	$BB echo 'chmod 0644 /sys/kernel/touchpanel/dclicknode' >> $DTTWInitFile
	$BB echo 'write /sys/kernel/touchpanel/dclicknode 1' >> $DTTWInitFile
	$BB echo 'chmod 0644 /proc/touchpanel/double_tap_enable' >> $DTTWInitFile
	$BB echo 'write /proc/touchpanel/double_tap_enable 1' >> $DTTWInitFile
	$BB echo '  exec u:r:init:s0 root root -- /vendor/bin/patch_dttw.sh' >> $DTTWInitFile
	$BB echo '  exec u:r:su:s0 root root -- /vendor/bin/patch_dttw.sh' >> $DTTWInitFile
	$BB echo '' >> $DTTWInitFile
	$BB echo 'on property:sys.boot_completed=1' >> $DTTWInitFile
	$BB echo 'chmod 0644 /proc/tpd_gesture' >> $DTTWInitFile
	$BB echo 'write /proc/tpd_gesture 1' >> $DTTWInitFile
	$BB echo 'chmod 0644 /sys/kernel/touchpanel/dclicknode' >> $DTTWInitFile
	$BB echo 'write /sys/kernel/touchpanel/dclicknode 1' >> $DTTWInitFile
	$BB echo 'chmod 0644 /proc/touchpanel/double_tap_enable' >> $DTTWInitFile
	$BB echo 'write /proc/touchpanel/double_tap_enable 1' >> $DTTWInitFile
	$BB echo '  exec u:r:init:s0 root root -- /vendor/bin/patch_dttw.sh' >> $DTTWInitFile
	$BB echo '  exec u:r:su:s0 root root -- /vendor/bin/patch_dttw.sh' >> $DTTWInitFile
	cp -af $DTTWInitFile /vendor/etc/init/hw/init.forcedttw.rc
    chmod -R 644 /vendor/etc/init/hw/init.forcedttw.rc
	cp -af $DTTWScriptFile /vendor/bin/patch_dttw.sh
    chmod -R 755 /vendor/bin/patch_dttw.sh
	grep "import /init.forcedttw.rc" /vendor/etc/init/hw/init.qcom.rc >/dev/null | sed -i '/import \/init.forcedttw.rc/d' /vendor/etc/init/hw/init.qcom.rc
    grep "import init.forcedttw.rc" /vendor/etc/init/hw/init.qcom.rc >/dev/null | sed -i '/import init.forcedttw.rc/d' /vendor/etc/init/hw/init.qcom.rc
    grep "import /vendor/etc/init/hw/init.forcedttw.rc" /vendor/etc/init/hw/init.qcom.rc >/dev/null || sed -i '1,/.*import.*/s/.*import.*/import \/vendor\/etc\/init\/hw\/init.forcedttw.rc\n&/' /vendor/etc/init/hw/init.qcom.rc
elif [ "`$BB grep -w "selected.2=2" /tmp/aroma-data/spectrum.prop`" ]; then
	if [ "$REG" = "IDN" ];then
	ui_print "- Mematikan Paksa DT2W ...";
	elif [ "$REG" = "EN" ];then
	ui_print "- Force Disabling DT2W ...";
	fi;
	DTTWScriptFile="/tmp/dttwpatch"
	DTTWInitFile="/tmp/dttwinit"
	$BB echo '#!/system/bin/sh' >> $DTTWScriptFile
	$BB echo '' >> $DTTWScriptFile
	$BB echo '# DT2W Disabler Script by sandatjepil' >> $DTTWScriptFile
	$BB echo '' >> $DTTWScriptFile
    $BB echo 'if [[ -f "/proc/touchpanel/double_tap_enable" ]]; then' >> $DTTWScriptFile
    $BB echo '  for dttw in $(find /proc/touchpanel -name "*enable"); do' >> $DTTWScriptFile
    $BB echo '    chmod -R 644 "$dttw"' >> $DTTWScriptFile
    $BB echo '    echo 0 > "$dttw"' >> $DTTWScriptFile
    $BB echo '  done' >> $DTTWScriptFile
    $BB echo 'elif [[ -f "/sys/kernel/touchpanel/dclicknode" ]]; then' >> $DTTWScriptFile
    $BB echo '  chmod -R 644 /sys/kernel/touchpanel/dclicknode' >> $DTTWScriptFile
    $BB echo '  echo 0 > "/sys/kernel/touchpanel/dclicknode"' >> $DTTWScriptFile
    $BB echo 'elif [[ -f "/proc/tpd_gesture" ]]; then' >> $DTTWScriptFile
    $BB echo '  chmod -R 644 /proc/tpd_gesture' >> $DTTWScriptFile
    $BB echo '  echo 0 > "/proc/tpd_gesture"' >> $DTTWScriptFile
    $BB echo 'fi' >> $DTTWScriptFile
	$BB echo '# DT2W Disabler Patch Init by RyuujiX' >> $DTTWInitFile
	$BB echo '# Refined by sandatjepil' >> $DTTWInitFile
	$BB echo '' >> $DTTWInitFile
	$BB echo 'on boot' >> $DTTWInitFile
	$BB echo 'chmod 0644 /proc/tpd_gesture' >> $DTTWInitFile
	$BB echo 'write /proc/tpd_gesture 0' >> $DTTWInitFile
	$BB echo 'chmod 0644 /sys/kernel/touchpanel/dclicknode' >> $DTTWInitFile
	$BB echo 'write /sys/kernel/touchpanel/dclicknode 0' >> $DTTWInitFile
	$BB echo 'chmod 0644 /proc/touchpanel/double_tap_enable' >> $DTTWInitFile
	$BB echo 'write /proc/touchpanel/double_tap_enable 0' >> $DTTWInitFile
	$BB echo 'chmod 0644 /proc/touchpanel/letter_c_enable' >> $DTTWInitFile
	$BB echo 'write /proc/touchpanel/letter_c_enable 0' >> $DTTWInitFile
	$BB echo 'chmod 0644 /proc/touchpanel/letter_e_enable' >> $DTTWInitFile
	$BB echo 'write /proc/touchpanel/letter_e_enable 0' >> $DTTWInitFile
	$BB echo 'chmod 0644 /proc/touchpanel/letter_s_enable' >> $DTTWInitFile
	$BB echo 'write /proc/touchpanel/letter_s_enable 0' >> $DTTWInitFile
	$BB echo 'chmod 0644 /proc/touchpanel/letter_v_enable' >> $DTTWInitFile
	$BB echo 'write /proc/touchpanel/letter_v_enable 0' >> $DTTWInitFile
	$BB echo 'chmod 0644 /proc/touchpanel/letter_w_enable' >> $DTTWInitFile
	$BB echo 'write /proc/touchpanel/letter_w_enable 0' >> $DTTWInitFile
	$BB echo 'chmod 0644 /proc/touchpanel/letter_z_enable' >> $DTTWInitFile
	$BB echo 'write /proc/touchpanel/letter_z_enable 0' >> $DTTWInitFile
	$BB echo 'chmod 0644 /proc/touchpanel/up_swipe_enable' >> $DTTWInitFile
	$BB echo 'write /proc/touchpanel/up_swipe_enable 0' >> $DTTWInitFile
	$BB echo '  exec u:r:init:s0 root root -- /vendor/bin/patch_dttw.sh' >> $DTTWInitFile
	$BB echo '  exec u:r:su:s0 root root -- /vendor/bin/patch_dttw.sh' >> $DTTWInitFile
	$BB echo '' >> $DTTWInitFile
	$BB echo 'on property:sys.boot_completed=1' >> $DTTWInitFile
	$BB echo 'chmod 0644 /proc/tpd_gesture' >> $DTTWInitFile
	$BB echo 'write /proc/tpd_gesture 0' >> $DTTWInitFile
	$BB echo 'chmod 0644 /sys/kernel/touchpanel/dclicknode' >> $DTTWInitFile
	$BB echo 'write /sys/kernel/touchpanel/dclicknode 0' >> $DTTWInitFile
	$BB echo 'chmod 0644 /proc/touchpanel/double_tap_enable' >> $DTTWInitFile
	$BB echo 'write /proc/touchpanel/double_tap_enable 0' >> $DTTWInitFile
	$BB echo 'chmod 0644 /proc/touchpanel/letter_c_enable' >> $DTTWInitFile
	$BB echo 'write /proc/touchpanel/letter_c_enable 0' >> $DTTWInitFile
	$BB echo 'chmod 0644 /proc/touchpanel/letter_e_enable' >> $DTTWInitFile
	$BB echo 'write /proc/touchpanel/letter_e_enable 0' >> $DTTWInitFile
	$BB echo 'chmod 0644 /proc/touchpanel/letter_s_enable' >> $DTTWInitFile
	$BB echo 'write /proc/touchpanel/letter_s_enable 0' >> $DTTWInitFile
	$BB echo 'chmod 0644 /proc/touchpanel/letter_v_enable' >> $DTTWInitFile
	$BB echo 'write /proc/touchpanel/letter_v_enable 0' >> $DTTWInitFile
	$BB echo 'chmod 0644 /proc/touchpanel/letter_w_enable' >> $DTTWInitFile
	$BB echo 'write /proc/touchpanel/letter_w_enable 0' >> $DTTWInitFile
	$BB echo 'chmod 0644 /proc/touchpanel/letter_z_enable' >> $DTTWInitFile
	$BB echo 'write /proc/touchpanel/letter_z_enable 0' >> $DTTWInitFile
	$BB echo 'chmod 0644 /proc/touchpanel/up_swipe_enable' >> $DTTWInitFile
	$BB echo 'write /proc/touchpanel/up_swipe_enable 0' >> $DTTWInitFile
	$BB echo '  exec u:r:init:s0 root root -- /vendor/bin/patch_dttw.sh' >> $DTTWInitFile
	$BB echo '  exec u:r:su:s0 root root -- /vendor/bin/patch_dttw.sh' >> $DTTWInitFile
	cp -af $DTTWInitFile /vendor/etc/init/hw/init.forcedttw.rc
    chmod -R 644 /vendor/etc/init/hw/init.forcedttw.rc
	cp -af $DTTWScriptFile /vendor/bin/patch_dttw.sh
    chmod -R 755 /vendor/bin/patch_dttw.sh
	grep "import /init.forcedttw.rc" /vendor/etc/init/hw/init.qcom.rc >/dev/null | sed -i '/import \/init.forcedttw.rc/d' /vendor/etc/init/hw/init.qcom.rc
    grep "import init.forcedttw.rc" /vendor/etc/init/hw/init.qcom.rc >/dev/null | sed -i '/import init.forcedttw.rc/d' /vendor/etc/init/hw/init.qcom.rc
    grep "import /vendor/etc/init/hw/init.forcedttw.rc" /vendor/etc/init/hw/init.qcom.rc >/dev/null || sed -i '1,/.*import.*/s/.*import.*/import \/vendor\/etc\/init\/hw\/init.forcedttw.rc\n&/' /vendor/etc/init/hw/init.qcom.rc
elif [ "`$BB grep -w "selected.2=3" /tmp/aroma-data/spectrum.prop`" ]; then
	if [ "$REG" = "IDN" ];then
	ui_print "- Menghapus Paksaan DT2W ...";
	elif [ "$REG" = "EN" ];then
	ui_print "- Removing Forced DT2W ...";
	fi;
	if [ -e /vendor/etc/init/hw/init.forcedttw.rc ]; then
	rm -rf /vendor/etc/init/hw/init.forcedttw.rc
	rm -rf /vendor/bin/patch_dttw.sh
	else
	if [ "$REG" = "IDN" ];then
    ui_print "! Skrip Paksaan DT2W tidak ditemukan. !";
    elif [ "$REG" = "EN" ];then
    ui_print "! Force DT2W Script not found. !";
    fi;
	fi;
fi;

  $BB mount -o ro,remount -t auto /system;
  $BB mount -o ro,remount -t auto /vendor 2>/dev/null;

if [ "`$BB grep -w "selected.1=2" /tmp/aroma-data/dummy.prop`" ]; then
DoneProcess
fi;
}

PatchRAM(){
$BB mount -o rw,remount -t auto /system;
$BB mount -o rw,remount -t auto /vendor 2>/dev/null;

if [ "`$BB grep -w "selected.4=1" /tmp/aroma-data/spectrum.prop`" ]; then
	if [ "$REG" = "IDN" ];then
    ui_print "- Menghapus Tambalan RAM...";
    elif [ "$REG" = "EN" ];then
    ui_print "- Removing RAM Patch...";
    fi;
	
	if [ -e /vendor/etc/init/hw/init.rampatch.rc ]; then
	rm -f /vendor/etc/init/hw/init.rampatch.rc
	rm -f /vendor/bin/patch_ram.sh
	elif [ -e /data/adb/service.d/12_ryuu_ram_patch ]; then
	rm -f /data/adb/service.d/12_ryuu_ram_patch
	else
	if [ "$REG" = "IDN" ];then
    ui_print "! Tambalan RAM tidak ditemukan. !";
    elif [ "$REG" = "EN" ];then
    ui_print "! RAM Patch not found. !";
    fi;
	fi
	
	if [ "`$BB grep -w "selected.1=3" /tmp/aroma-data/dummy.prop`" ]; then
	DoneProcess
	fi
	
elif [ "`$BB grep -w "selected.4=2" /tmp/aroma-data/spectrum.prop`" ]; then
RAMPatchMode="Magisk"
elif [ "`$BB grep -w "selected.4=3" /tmp/aroma-data/spectrum.prop`" ]; then
RAMPatchMode="Init"
fi
if [ ! -z "$RAMPatchMode" ];then
RealTotalRAM="$($BB awk '/MemTotal/ { print $2 }' /proc/meminfo | cut -c -2)"
RAMScriptFile="/tmp/rampatch"
RAMInitFile="/tmp/raminit"

if [ "$RealTotalRAM" -lt "30" ] || [ "$RealTotalRAM" == "30" ];then
	TotalRAM="3"
	MinFreeValue="1536,2048,4096,5120,10240,15000"
else
	if [ "$RealTotalRAM" -gt "30" ] && [ "$RealTotalRAM" -lt "40" ] || [ "$RealTotalRAM" == "40" ];then
	TotalRAM="4"
	elif [ "$RealTotalRAM" -gt "40" ] && [ "$RealTotalRAM" -lt "60" ] || [ "$RealTotalRAM" == "60" ];then
	TotalRAM="6"
	fi
	MinFreeValue="25600,34560,38400,52224,71680,84480"
fi

	if [ "$REG" = "IDN" ];then
	ui_print "- Total RAM: $TotalRAM GB"
	ui_print "- Menambal RAM ($RAMPatchMode) ...";
	elif [ "$REG" = "EN" ];then
	ui_print "- RAM Total: $TotalRAM GB"
	ui_print "- Patching RAM ($RAMPatchMode) ...";
	fi;

$BB echo '#! /system/bin/sh' >> $RAMScriptFile
$BB echo '' >> $RAMScriptFile
$BB echo '# RAM Patch Script by RyuujiX' >> $RAMScriptFile
$BB echo "# Inspired from R0thbaby's and Pk's RAM Patch" >> $RAMScriptFile
$BB echo '' >> $RAMScriptFile
$BB echo '# Set LMK Parameters' >> $RAMScriptFile
$BB echo "echo '$MinFreeValue' > /sys/module/lowmemorykiller/parameters/minfree" >> $RAMScriptFile
$BB echo '# Disabling LMK Parameters that will cause parameters to be modified.' >> $RAMScriptFile
$BB echo "chmod -R 444 /sys/module/lowmemorykiller/parameters/*" >> $RAMScriptFile
if [ "$RAMPatchMode" = "Magisk" ];then
if [ ! -e /data/adb/service.d ]; then
mkdir -p /data/adb/service.d
chmod -R 755 /data/adb/service.d
else
rm -f /data/adb/service.d/12_ryuu_ram_patch
fi
mv -f $RAMScriptFile /data/adb/service.d/12_ryuu_ram_patch
chmod -R 755 /data/adb/service.d/12_ryuu_ram_patch
elif [ "$RAMPatchMode" = "Init" ];then
$BB echo '# RAM Patch Init by RyuujiX' >> $RAMInitFile
$BB echo "# Inspired from R0thbaby's and Pk's RAM Patch" >> $RAMInitFile
$BB echo '' >> $RAMInitFile
$BB echo 'on boot' >> $RAMInitFile
$BB echo '  # Set LMK Parameters' >> $RAMInitFile
$BB echo "  write /sys/module/lowmemorykiller/parameters/minfree $MinFreeValue" >> $RAMInitFile
$BB echo '  # Disabling LMK Parameters that will cause parameters to be modified.' >> $RAMInitFile
$BB echo "  chmod 0444 /sys/module/lowmemorykiller/parameters/*" >> $RAMInitFile
$BB echo '  exec u:r:init:s0 root root -- /vendor/bin/patch_ram.sh' >> $RAMInitFile
$BB echo '  exec u:r:su:s0 root root -- /vendor/bin/patch_ram.sh' >> $RAMInitFile
$BB echo '' >> $RAMInitFile
$BB echo 'on property:sys.boot_completed=1' >> $RAMInitFile
$BB echo '  # Set LMK Parameters' >> $RAMInitFile
$BB echo "  write /sys/module/lowmemorykiller/parameters/minfree $MinFreeValue" >> $RAMInitFile
$BB echo '  # Disabling LMK Parameters that will cause parameters to be modified.' >> $RAMInitFile
$BB echo "  chmod 0444 /sys/module/lowmemorykiller/parameters/*" >> $RAMInitFile
$BB echo '  exec u:r:init:s0 root root -- /vendor/bin/patch_ram.sh' >> $RAMInitFile
$BB echo '  exec u:r:su:s0 root root -- /vendor/bin/patch_ram.sh' >> $RAMInitFile
mv -f $RAMInitFile /vendor/etc/init/hw/init.rampatch.rc
chmod -R 644 /vendor/etc/init/hw/init.rampatch.rc
mv -f $RAMScriptFile /vendor/bin/patch_ram.sh
chmod -R 755 /vendor/bin/patch_ram.sh
grep "import /init.rampatch.rc" /vendor/etc/init/hw/init.qcom.rc >/dev/null | sed -i '/import \/init.rampatch.rc/d' /vendor/etc/init/hw/init.qcom.rc
grep "import init.rampatch.rc" /vendor/etc/init/hw/init.qcom.rc >/dev/null | sed -i '/import init.rampatch.rc/d' /vendor/etc/init/hw/init.qcom.rc
grep "import /vendor/etc/init/hw/init.rampatch.rc" /vendor/etc/init/hw/init.qcom.rc >/dev/null || sed -i '1,/.*import.*/s/.*import.*/import \/vendor\/etc\/init\/hw\/init.rampatch.rc\n&/' /vendor/etc/init/hw/init.qcom.rc
fi

if [ "`$BB grep -w "selected.1=3" /tmp/aroma-data/dummy.prop`" ]; then
DoneProcess
fi;
else
	if [ "$REG" = "IDN" ];then
	ui_print "- Melompati Tambal RAM ...";
	elif [ "$REG" = "EN" ];then
	ui_print "- Skipping RAM Patch...";
	fi;
fi;

$BB mount -o ro,remount -t auto /system;
$BB mount -o ro,remount -t auto /vendor 2>/dev/null;
}

show_progress 1.34 4;
ui_print " ";
cleanup;
mkdir -p $AKHOME/bin;
cd $AKHOME;
unzip -o "$ZIPFILE";
if [ $? != 0 -o ! "$(ls tools)" ]; then
  abort "Unzip failed. Aborting...";
fi;
for ARCH32 in x86 arm; do
  if [ -d $AKHOME/tools/$ARCH32 ]; then
    BB=$AKHOME/tools/$ARCH32/busybox;
    chmod 755 $BB;
    $BB >/dev/null 2>&1;
    if [ $? == 0 ]; then
      $BB mv -f $AKHOME/tools/$ARCH32/* $AKHOME/tools;
      break;
    fi;
  fi;
done;
BB=$AKHOME/tools/busybox;
chmod 755 $BB;
$BB chmod -R 755 tools bin;
$BB --install -s bin;
if [ $? != 0 -o -z "$(ls bin)" ]; then
  abort "Busybox setup failed. Aborting...";
fi;

# MultiLanguage Support
if [ "`$BB grep -w "selected.0=2" /tmp/aroma-data/lang.prop`" ];then
  REG=IDN;
else
  REG=EN;
fi;
	
if [ -f banner ]; then
  ui_printfile banner;
  ui_print " ";
fi;

KERNEL_STRING="$(file_getprop anykernel.sh kernel.string)";
KERNEL_FOR="$(file_getprop anykernel.sh kernel.for)";
KERNEL_COMPILER="$(file_getprop anykernel.sh kernel.compiler)";
KERNEL_MADE="$(file_getprop anykernel.sh kernel.made)";
KERNEL_VERSION="$(file_getprop anykernel.sh kernel.version)";
KERNEL_TYPE="$(file_getprop anykernel.sh kernel.type)";
MESSAGE_WORD="$(file_getprop anykernel.sh message.word)";
BUILD_DATE="$(file_getprop anykernel.sh build.date)";
DEVICE_NAME="$(file_getprop anykernel.sh device.name3)";
BUILD_TYPE="$(file_getprop anykernel.sh build.type)";
if [ "$REG" = "IDN" ];then
ui_print "-- Nama Kernel    : $KERNEL_STRING";
ui_print "-- Versi Kernel   : $KERNEL_VERSION";
ui_print "-- Varian         : $KERNEL_FOR - $KERNEL_TYPE";
ui_print "-- PengKompilasi  : $KERNEL_COMPILER";
ui_print "-- Perangkat      : $DEVICE_NAME";
ui_print "-- Tanggal Build  : $BUILD_DATE";
ui_print "-- Tipe Build     : $BUILD_TYPE";
ui_print "-- DiBuild Oleh   : $KERNEL_MADE";
elif [ "$REG" = "EN" ];then
ui_print "-- Kernel Name    : $KERNEL_STRING";
ui_print "-- Kernel Version : $KERNEL_VERSION";
ui_print "-- Variant        : $KERNEL_FOR - $KERNEL_TYPE";
ui_print "-- Compiler       : $KERNEL_COMPILER";
ui_print "-- Device         : $DEVICE_NAME";
ui_print "-- Build Date     : $BUILD_DATE";
ui_print "-- Build Type     : $BUILD_TYPE";
ui_print "-- Builded by     : $KERNEL_MADE";
fi;
ui_print "_________________________________________________" " ";
if [ -f version ]; then
  ui_print " ";
  ui_printfile version;
  ui_print " ";
fi;

if [ "$REG" = "IDN" ];then
ui_print "- Menyiapkan Pengaturan Lingkungan ...";
elif [ "$REG" = "EN" ];then
ui_print "- Preparing Environment Setup ...";
fi;
setup_env;

if [ "`$BB grep -w "selected.2=4" /tmp/aroma-data/spectrum.prop`" ]; then
RestorePerfHAL;
elif [ "`$BB grep -w "selected.1=2" /tmp/aroma-data/dummy.prop`" ]; then
DoubleTapWake;
elif [ "`$BB grep -w "selected.1=3" /tmp/aroma-data/dummy.prop`" ]; then
PatchRAM;
else
do_devicecheck;
do_versioncheck;
do_levelcheck;

if [ "`$BB grep -w "selected.2=1" /tmp/aroma-data/refrate.prop`" ];then
	if [ "$REG" = "IDN" ];then
	ui_print "- Mencadangkan Boot.img...";
	elif [ "$REG" = "EN" ];then
	ui_print "- Backing up Boot.img ...";
	fi;
	mkdir -p /sdcard/BootBackup
	$BB dd if=/dev/block/bootdevice/by-name/boot of=/sdcard/BootBackup/boot-backup-$(date "+%Y%m%d%H%M%S").img
fi;

if [ "$REG" = "IDN" ];then
ui_print "- Memasang Kernel...";
elif [ "$REG" = "EN" ];then
ui_print "- Installing Kernel...";
fi;
CORE=$($BB grep -oE 'ak.*core.sh' anykernel.sh);
[ -f tools/$CORE ] || $BB ln -s $AKHOME/tools/ak*-core.sh $AKHOME/tools/$CORE;
PATH="$AKHOME/bin:$PATH" home=$AKHOME $BB ash anykernel.sh $2;
if [ $? != 0 ]; then
  abort;
fi;

do_modules;

# custom script for add spectrum support to kernel
AddSpectrum;
refreshrate;
DoubleTapWake;
RestorePerfHAL;
PatchRAM;

debugging;
restore_env;
if [ "$(file_getprop anykernel.sh do.cleanup)" == 1 ]; then
  cleanup;
fi;

DoneProcess

ui_print " " "_________________________________________________";
ui_print " " "$MESSAGE_WORD" "_________________________________________________" " ";
fi;
